using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Years.Utils;

namespace Years.Year2021
{
    public class Day20 : IDay
    {
        public int Day => 20;
        public int Year => 2021;

        public void ProblemOne()
        {
            var (pixels, width, height, algorithm) = ParseInput(Input);
            (pixels, width, height) = ApplyAlgorithm(pixels, width, height, algorithm, Cycle.AllZero);
            (pixels, width, height) = ApplyAlgorithm(pixels, width, height, algorithm, Cycle.AllOne);
            Console.WriteLine(pixels.Count);
        }

        public void ProblemTwo()
        {
            var (pixels, width, height, algorithm) = ParseInput(Input);

            for(var i = 0; i < 50; i+=2)
            {
                (pixels, width, height) = ApplyAlgorithm(pixels, width, height, algorithm, Cycle.AllZero);
                (pixels, width, height) = ApplyAlgorithm(pixels, width, height, algorithm, Cycle.AllOne);
            }
            Console.WriteLine(pixels.Count);
        }


        private void Draw(HashSet<Vector2i> image)
        {
            Console.Clear();
            for (var y = 0; y <= image.Max(i => i.Y); y++)
            {
                for (var x = 0; x <= image.Max(i => i.X); x++)
                {
                    Console.SetCursorPosition(x, y);
                    var vec = new Vector2i(x, y);
                    if (image.Contains(vec))
                    {
                        Console.Write('#');
                    }
                    else
                    {
                        Console.Write('.');
                    }
                }
            }
        }

        private enum Cycle
        {
            NoCycyle,
            AllZero,
            AllOne,
        }


        private (HashSet<Vector2i> image, int width, int height) ApplyAlgorithm(HashSet<Vector2i> image, int width, int height, string algorithm, Cycle cycle)
        {
            var nextImage = new HashSet<Vector2i>();            
            for (var y = -1; y <= height+1; y++)
            {
                for (var x = -1; x <= width+1; x++)
                {
                    var vec = new Vector2i(x, y);

                    //Build the binary number
                    //[1,2,3]
                    //[4,5,6]
                    //[7,8,9]
                    var coords = new List<Vector2i>()
                    {
                        new Vector2i(-1, -1).Add(vec),  //1
                        new Vector2i( 0, -1).Add(vec),  //2
                        new Vector2i( 1, -1).Add(vec),  //3
                        new Vector2i(-1,  0).Add(vec),  //4 
                        vec,                            //5
                        new Vector2i( 1,  0).Add(vec),  //6
                        new Vector2i(-1,  1).Add(vec),  //7
                        new Vector2i( 0,  1).Add(vec),  //8
                        new Vector2i( 1,  1).Add(vec),  //9
                    };

                    var bin = 0;
                    for (var i = 0; i < coords.Count; i++)
                    {
                        //if image contains this pixel
                        if (image.Contains(coords[i]))
                        {
                            bin |= 1 << (8 - i);
                        }

                        //Or if we're "out of bounds" - image is infinite - we might be on a 0's cycle or 1's (entire image onverted to 0's or 1's)
                        if(cycle != Cycle.NoCycyle && (coords[i].X < 0 || coords[i].Y < 0 || coords[i].X > width || coords[i].Y > height))
                        {
                            var bit = cycle == Cycle.AllOne ? 1 : 0;
                            bin |= bit << (8 - i);
                        }
                    }

                    //Use bin number, transform all coords 1,1 so that they will never be negative (because we start at -1,-1)
                    if (algorithm[bin] == '#')
                    {
                        nextImage.Add(vec.Add(new Vector2i(1,1)));
                    }
                }
            }

            return (nextImage, width+2, height+2);
        }


        private (HashSet<Vector2i> image, int width, int height, string algorithm) ParseInput(string input)
        {
            var lines = input.SplitNewLine().ToList();
            var algorithm = lines[0];
            lines = lines.Skip(2).ToList();

            var image = new HashSet<Vector2i>();
            for (var y = 0; y < lines.Count; y++)
            {
                for (var x = 0; x < lines[0].Length; x++)
                {
                    if (lines[y][x] == '#')
                    {
                        image.Add(new Vector2i(x, y));
                    }
                }
            }
            var width = image.Max(i => i.X);
            var height = image.Max(i => i.Y);
            return (image, width, height, algorithm);
        }

        private const string Example = 
            @"..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..###..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#..#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#......#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#.....####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.......##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#

#..#.
#....
##..#
..#..
..###";

        private const string Input = 
            @"#..#.#######.##...##.##.#.#..#..#.....####...####.##.###...##.####......##.###.##...#..##..#.######...###..########.#.##.#.#..#..##.##..####.###.###..#...##.##.###.....###..###....#.####.#..##....#.##...##.#..#.....###.#..#.....##..##.#.#.....#....####.#.#.#....#.#...#.##...#.#.#....#.#.#....##.#.####.##..#####.####.#.####..#...###.###..##...#..###.####...#..#.####.###.##..##....#.####....#.#..##.#..#.##.##..#......###.#...#..#.#.#.##.######.##.##..####.##..#.###.##.....##...#.....#..#....###..####.#.##..#.

#.#...#.....#..#.#....#.#.###.......###.###...##...#..#..###.###...##...#.#####...##..##.#.#..##....
##.####...#.#.#.##.##....###.##..##..#.##....#.####.#.#####.#..............#.###...#..#####.#....###
#.#...#..#.##..#.#.#.##.##..####..####.#..#####.#.....#####..#.##..####.#.....#.#..##..##....##.#.#.
.#..##.##.#######....####.##..######..##...#...#####....##.######.##..#..##.#.#.#.#..#....#.##.###.#
...#.###.##..##..##.#..###..#.#..#..#...#..........##..##.##..#.#...##.#.#.#.#...##.#..##.....##.##.
...##.#.#..####..#.##.#.#....#.#..#####.#..#.#.#.##..###.##..###.##...###.##.#...#.##.##........##..
#..#.#......#..##.#......#..##..#.#.#.....#.#####.##...#......#.#...##.###.#.#.#.#..###..#.##.#.....
#.#..##.#.###...#.##.#.##..########.####.#.#...##.#.##....#.....#...#..##.####.#...##.#.##.#.#...#.#
##.....#.###...##....#...##.####.####..#....##.#.#.##...#.#######.#.####.##.#.##.##.....##.####.#...
#.#.##.###.#...##.#.#.###..#.#.#..##.######..#.##......#..##..###.#.#...#...###.#.#..#.##.###..#..##
#####....#####.......##.#.#...###.##.###..##.##....#.####.####..........####.#...#....####..##.#####
.#.#..#.#...#.#..#..##.#.#.#...##.....##.###.#.#......#.#.#.##..#..###..#.#..#.###...###.#.#.#.#.#.#
#.#..###..##.#.#.#...##.####..##....#.##.#.#...#..#...#..#..#..##....#.......#######.#.##...#.###.##
#..#..#####...##.###.#.#.#.#....#..#.####.####...#..#.##.####.####.###.#.##.#..##.#.##.##.#.#...##.#
..#.###...#.####...##..#.###....##.#..#..#.#.#....##...####.##..#.#.##...##.......#.#..#..##.#.##...
#...##.##..#...#.###.#.#.##..##...####.##.#.#..#....#####....##.#####..#####.#..##.#.....##.###..##.
..#..###..#.#.########.#######..######...##.##.##..##...####..##....#....##..#...##...#.####.#...##.
.......##.#.#...##.#..#.##.#..##.##..#......#####.#....#..#..#####....#.#..#.##.##.#.#..###..##.####
.#...##..######.#...##.#######.####.####...#.####......###.#.#.#.###..#...#.#..#.#..##...#..##.#.#.#
####.#.####..#..#...#..####.#......####...###....##########...####.#...#...#.###..###.....#....#..#.
...#.##.....###...##.#..##.....#..##.##........##.####.##..#...#..######...##.#....##..#..#######.#.
##.##..#...#....#.........###.........##...#........#.#.###..#...#.#.##....#.......#....##.##..#####
.######.##..####...#...#.##..####...#######.###...#.#.#...##.#......###..#..#.#.#...##........##.##.
.#.##.##.....#......##.##.#.##..##....##..#####.........#.##........#..######.##.#.#......#.....##.#
#.#.######.#..##.#.##..#.###..#.#..##...###.###...#.#.......#.##...#.#..#....###..####.##..#.#.##.#.
.#..#...#.#..#.......###...#.##.####..##.#......#..#.#..####.#.#...###.##.#.....#...###.#....###.##.
#..##.#...##..####.#.##..#..####.##.###.....###..#.####.##.#####...######.#.###.###.##.######..#..#.
######.#.#.#.#..#.##.#......###......##..#....#...#..##...#..#.##..#.#####.######...##..#.##..###.##
#..##...#.#..#..##.####....#.#..##.###...##..#####.##.#....###.......#.#.#.#......##.##.#..#.#.#.#.#
.#..#..#.######.#.....##.#.#...#....#########....########...##...##.#..#.###.##.#..#..#######.#.##..
..##...##.###..##......#...#..#....#....###..##.#..###.#...##.#..#.####.#.##...#..####.....##..##...
#.##...###...#...#.##..#.....##.###.##...#.#..#.##.#..###..#.##.##.....#.##..#.####..#.#.#..###.##.#
#...#..#.#...##.#..##.##.#..##.#...###...###...#..###..########.####.###.#.....#..#..###.#.##...#.##
#.##.######.####...#.#...###.#..#...#.#.###.##.#...##...##.##.###.##.####..#.#####...#....###....##.
#...#.#.##.#.#..###..#.#..##.##..###..#.#.#..#..#..####.##..##.#..#..............#.###.##.#.#..#####
##.#..#.##...#....####.##....#..##.###......#..##....##########.#.###...#.##...#..##.#....#...#.####
#..#.#...#.#..#....##.##...###.....####..#..##.##.####..#.#.#.######..#...##...#.........##.#.####..
.#..#.#.#....#.#...##..#.#.##.##.....######...###.##.##.##.#..###...##.#.....##.##..#..####..###..#.
.#.##..##....#.###.#...##....#..#.########.##.#.#..#######...##.#.###.#.###...###.#..###.....####...
#.##...#...###.####.###.#.##.#.##..#..#.####...###..###..#...##...#.#.#..###.#.#####.#######.###.###
##.#####.#..##.#..#.##.##..........######.#.###.###.#...##..##..#.......##..#.##.##.###.####......##
#.###..##....#.###...#...#.#..###...##.###.###.####.##..#####.#...#.####...##..######....#...#.#####
.#.#.####....#####...#...###..#...#.....###..###.##.#.....#..#.#.#.##..##.....##.....###.#...#.####.
##....##..#..#.##..##..#.#.#.#...#.#......##.#..#.##.#..#.###..#.#.#..##......####...#..#.##..####..
##..#.##.........######.#..##...#.##.###.#.#######.##...#.#####...#........######....#.#.####...#.##
##.#.......##.#...#.....#.#.####.#.##.##...#.##.#..#.#.##..###.#..##....#...##..##.##.#.##.#....#...
...#######...#..####..#.###.#.##..#.....#..##...###.....###.....##...##.#.......##.#.#.#.##....####.
.##.##...#...####.......##...##.##..#...###.#.#...#.####.##.#.######...#.#..###.##..####.##.##...#..
.#######.###.##...#.####...#.......#.#..##.##.#####.#.#....#..###.#.##...#.###...#...##.#..###......
##.#..#...##.####.#.###.####.#.##.#.##.......###..#####.#..#..###.####.#..#....#..#..##..#...#.##.#.
.#..###.##....##..##.######..#####..##.##....#.####....#.#.###...##...#######....####.#.##...##.#..#
#.###.##.....#...#..#..###..##.#..#..##.##.#...#...#.#....#......#.#.##.#.##.##...##.##.##.#....#.#.
..#.#.###.#..#.#.##.#.#..#.#.#.#.##...#.##..######.##.#####...#...##..#.###.##...#.#.#..#.#######.##
###.######..###...#.#.##.....###.......##.##.#........##..##...##.#.#.#.##.###.##.##..#......##..###
.#..#.#.##...#..##......###....#..##.#..##.##..##....###....##.#..##...###..##..#.####..##...#######
##.#..####..##....#..####..#.#.##..###...##.#.#...##.#..###.##..###.####.##.#.###..#...#.##.#...#.##
...#..#.....#...#...###..####.##....#.##.##.#...###.#..#####.#.##.#..#..##......#..##.##..###.#...##
.#..#..########.#...#.####..#.#..#..#..####...##.#.####.#.#...#.#.###..#####.###.....####.#..#.#.#..
...#.#####.###.#..#.##.#.#...#.##....#####..##.##..############.#.##..#.#.....###.#.############....
..#..#....#..#..##.######..###...##..#.....##.#.##....#..####.#...#..##.....##..##.###.##.#..#######
#..#..##......#...####.####.##...######.#..##...###..#.#.#########..###.#.##.#.##.#...#.####.##...#.
.##.#...###.###..#.##...#...#..##.#....#.#....###.###.##.####.#.#.#..#....#.##.###..#...##..#...#.##
..##..#...##.#..#...#....#....###.##.##.##...##..####..#####.###.#.#....#.##....###.#....##...###.##
######.........#..#...####.#.......#.#####.#..#....#.#.####.#####...##..#####..###.#.#.##.###...#.##
...#.#...#.#..####.##....##.##.##.##...#...#..##..######.####..##.#.#..##..##.##...##.#...######....
.##..####..#.........####....##....#..##...#####....#.#...#......##.#.#.##...###..##.##..####..####.
#####...#.##...#######.#.######..##.....#..##...#..###.###..####.####.#####.#..#...##.....##.###..#.
##........#...#..#....#.###.##....#..#..###.#..##.#####.##....#.#..#.#..##.##...##.#....##..##.###..
###.#..#.###.#.###.###.#....##....#.#..##..####.###.##...##.##.#...#...#.....#####....###.#.##.##.##
.#...#....#.#...#.####..#..#...###..##.#..##.......##...##.##.#..#.#..##.##..##..###..##....##.#...#
###.#.#...#..#..###.#.#.##.....#..##...#.#....##.##.....###.####......####....#..##..#.#....#.##.#..
........#..#.#.##.##...#...#.#.##...##.#..#..#.#.##.####.###..######.##...#...#.##.#.###..##.#..##..
....##.#####.#.##.#.....#.#.###....#.###...#.####.##.##.#.########.##.#..##.#.##.##########.#..#...#
#..........###.####..#.....##....#.##.##..###.##........#..#...###.#..#..##.#.#.###.#.##.####..#####
#...#..##...#.#..#...###.#...#..#.###...###..#....####.##.###..#.#...##...##.#..#.###...#..###...###
####.###....####.#..#....#.#...##.#.######..#..#...##....#.#######...####..#.##......#...#..###..#..
##.#.#####.###.#...#.##..######..#...#.#####..#.##.#.#.##.###....######.#.....#..##..##..#...##..#..
.#########.##.##...#.#...##.###.#....###.#......#....##.##.#..####..##..##..#.##..#...#########....#
##....##.##..###....#...#..#...#.##.##..#######.#.##..##.#.#..#.###.##.###.#.#.#.##.#...##.######.#.
.##.#.#.#####.##...#.##...#...#..####.##..#.######..##.#.#.#....#...#..#.####.#..#..#.#...##.....###
..##.##..#........#........#.#.#.##.#....####....##....##.##...##.#.#...####.##.#####.....##.#.#.#..
#..####.#....##.###.#######..#...#..##.#...##..##.#.##..##.#.##.#.#...#.#.###.#..#.##.###..#.#....#.
#....#...#..##.##.####.#..#..####...#.#.#...#######...##..##...#.#.########...#..##.##.#...#.###.###
...##..##.##.###..###...#.####..#.....##.#..#.....##....##.#.####..#..#...##..#.#..#######.##.#...##
###...#...##.##.#...#..##.#####.######.###....###........#.##......#.###...###.#.#.##.#####..####.#.
.#########.#####....##.##..#.####.##..####.#...#.###.##.##..####.##..###......#...##..#.#.###.#..##.
.#.###..###....#####.#......#.###......###########..####.#......##.#..#..##..#.#.....#.#...#.##.##.#
..###...#.#.###....#..#####.#.###.###..#.#.#.#..#..##...#..###..#####...#.###.#.##.#.##.##.#.......#
.###..#.##..#..#.##.....#....##..#.#........##.##.########.....###..#....########.#.##.##..#.......#
.#.#..#####..###.#..#...#..#.##..###..#.###.#.##...#..###.#.#.#.##...####.####.#...#..#.###..#.###.#
#.#..##..#...###.#..####...#..#..##.###...###.##.#...#.#......##..##.#####.####....#...##.#..#..##.#
#....#...####.....#.##.#....#.#.##..#....##..####....#..###...#.#.##.#....#.###.###.....#.....#.#.##
#.##.#...#..#...########...#...##...###.##..###..#..##.#.#.#####.#....###.#..#..#.#.#...###.#.##.###
..##.#.###.#..##.#.##..##.##..##.....#..#....#.##.#...###.###....##..####..##....##.###.###.....#..#
#.##.###...##..##...#......#.#..#.......##.#.#.##.##..#....###.#..#.##.###.##....#.##....#.##.###..#
.##..#....#.#...#.###.#.##.#.##....####.######.#.#....##.##.....#.##.####..#.......##..##.#.##.....#
.###.##.....#...#.#..#.#..#..#...###.........#######.#..#######...#...#...#..######.#..#####.###....
#.....#..#....#####.....#....##.#.##..###..##..###.##..#.##..###....#.##...#####.#.#..#.##..##..#.#.
#.#..#....#.#...###.###.##...#.######.##.###..#..#..##.#.##.##.###..####..#..#..#..#...###..##.#..##
....#.###....#.#..##.#.##..#.###..#.#.##..#.#..##.#########..#.###...#.#.#....#.....####...#...##..#";
    }
}